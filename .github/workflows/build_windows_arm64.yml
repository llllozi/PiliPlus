name: Build for Windows arm64

on:
  workflow_dispatch:
  workflow_call:

jobs:
  build-windows-app:
    name: Release Windows arm64
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 强制使用支持 ARM64 的新版 Flutter
      - name: Setup flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: '3.27.1'

      # 【修正点】只开启 Desktop 支持，不要再运行 enable-windows-arm64 (新版已废弃该命令)
      - name: Enable Windows Desktop support
        run: |
          flutter config --enable-windows-desktop
        shell: pwsh

      - name: Install dependencies
        run: flutter pub get

      - name: Add Inno Setup
        run: choco install innosetup

      - name: Add Chinese language file for Inno Setup
        run: |
          if (Test-Path "windows/packaging/exe/ChineseSimplified.isl") {
            Copy-Item "windows/packaging/exe/ChineseSimplified.isl" "C:\Program Files (x86)\Inno Setup 6\Languages\ChineseSimplified.isl"
          }
        shell: pwsh

      - name: Set and Extract version
        shell: pwsh
        run: lib/scripts/build.ps1

      # 构建 Windows ARM64 版本
      - name: Build Windows (Native ARM64)
        run: |
          flutter build windows --arch=arm64 --release --dart-define-from-file=pili_release.json

      # 打包产物 (使用通配符修复路径问题)
      - name: Package Artifacts
        run: |
          mkdir -p Release/PiliPlus-Win
          
          # 使用 * 通配符，无视路径差异
          Write-Host "Moving built files..."
          Move-Item build/windows/*/runner/Release/* Release/PiliPlus-Win/ -Force
          
          Compress-Archive -Path "Release/PiliPlus-Win" -DestinationPath "PiliPlus_windows_arm64.zip"
        shell: pwsh

      # 上传 ZIP 包
      - name: Upload Portable ZIP
        uses: actions/upload-artifact@v4
        with:
          name: PiliPlus-Windows-ARM64-Portable
          path: PiliPlus_windows_arm64.zip
