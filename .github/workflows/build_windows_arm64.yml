name: Build for Windows arm64

on:
  workflow_dispatch:

jobs:
  build-windows-app:
    name: Release Windows arm64
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml

      - name: Install dependencies
        run: flutter pub get

      - name: Set Version
        shell: pwsh
        run: lib/scripts/build.ps1

      - name: Build Windows (Standard)
        # 直接调用 flutter 官方命令，不再经过 fastforge 包装
        # 如果报错提示找不到 pili_release.json，请删除 --dart-define... 那一段参数
        run: flutter build windows --arch=arm64 --release --dart-define-from-file=pili_release.json

      - name: Prepare Artifacts
        run: |
          mkdir -p Release/PiliPlus-Win
          # 使用原生命令后，文件一定会出现在这里
          # 使用通配符 * 匹配 arm64 或 runner 目录，确保万无一失
          mv build/windows/*/runner/Release/* Release/PiliPlus-Win/

      - name: Upload Portable Zip
        uses: actions/upload-artifact@v5
        with:
          name: PiliPlus-Windows-arm64
          path: Release/PiliPlus-Win
