name: Build for Windows arm64

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "tag"
        required: false
        default: ""
        type: string
      create_test_artifacts:
        description: "If true, create small test artifacts when no real build artifacts found"
        required: false
        default: false
        type: boolean

jobs:
  build-windows-app-arm64:
    name: Build and upload artifacts (Windows arm64)
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml

      - name: Add fastforge and Inno Setup
        shell: pwsh
        run: |
          dart pub global activate fastforge
          choco install innosetup -y

      - name: Set and Extract version
        shell: pwsh
        run: lib/scripts/build.ps1

      - id: set_tag
        name: Determine release tag
        shell: pwsh
        run: |
          $inputTag = '${{ github.event.inputs.tag }}'
          $envVersion = $env:version
          if ($inputTag -and $inputTag -ne '') { $tag = $inputTag }
          elseif ($envVersion -and $envVersion -ne '') { $tag = "v$envVersion" }
          else { $tag = "auto-${{ github.run_id }}" }
          Write-Host "Using tag: $tag"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "release_tag=$tag"

      - name: Build Windows (arm64)
        shell: pwsh
        run: |
          fastforge package --platform windows --targets exe --flutter-build-args="--arch=arm64 --dart-define-from-file=pili_release.json"

      - name: Debug - list dist and likely folders (for troubleshooting)
        shell: pwsh
        run: |
          Write-Host "PWD: $(Get-Location)"
          Write-Host "`n-- top-level --"
          Get-ChildItem -Force | Select Name,Mode,Length,LastWriteTime | Format-Table -AutoSize
          Write-Host "`n-- dist/ tree --"
          if (Test-Path dist) {
            Get-ChildItem -Path dist -Recurse -Force | Select-Object FullName,Length,LastWriteTime | Format-Table -AutoSize
          } else {
            Write-Host "No dist/ folder"
          }
          Write-Host "`n-- windows/packaging and build/ tree --"
          if (Test-Path windows) {
            Get-ChildItem -Path windows -Recurse -Force | Select-Object FullName,Length,LastWriteTime | Out-String -Width 300 | Write-Host
          } else {
            Write-Host "No windows/ folder"
          }
          if (Test-Path build) {
            Get-ChildItem -Path build -Recurse -Force | Select-Object FullName,Length,LastWriteTime | Out-String -Width 300 | Write-Host
          } else {
            Write-Host "No build/ folder"
          }

      - id: prepare
        name: Prepare artifacts (collect everything from dist and common paths)
        shell: pwsh
        env:
          CREATE_TEST_ARTIFACTS: ${{ github.event.inputs.create_test_artifacts }}
          RELEASE_TAG: ${{ steps.set_tag.outputs.release_tag }}
        run: |
          $cwd = Get-Location
          $releaseDir = Join-Path $cwd "Release\PiliPlus-Win"
          $setupDir   = Join-Path $cwd "PiliPlus-Win-Setup"
          New-Item -ItemType Directory -Path $releaseDir -Force | Out-Null
          New-Item -ItemType Directory -Path $setupDir -Force | Out-Null

          Write-Host "Collecting files from dist/ (all files) ..."
          if (Test-Path dist) {
            $distFiles = Get-ChildItem -Path dist -Recurse -File -ErrorAction SilentlyContinue
            foreach ($f in $distFiles) {
              $dest = Join-Path $releaseDir $f.Name
              Copy-Item -Path $f.FullName -Destination $dest -Force -ErrorAction SilentlyContinue
              Write-Host "Copied from dist: $($f.FullName) -> $dest"
            }
          } else {
            Write-Host "dist/ not found"
          }

          # Also collect from common windows output locations (if any)
          $otherPatterns = @(
            "build\windows\arm64\runner\Release\*",
            "build\windows\runner\Release\*",
            "build\windows\arm64\Release\*",
            "build\windows\Release\*",
            "windows\packaging\**\*"
          )

          foreach ($p in $otherPatterns) {
            Write-Host "Searching pattern: $p"
            Try {
              $items = Get-ChildItem -Path $p -File -Recurse -ErrorAction SilentlyContinue
              if ($items) {
                foreach ($it in $items) {
                  $dest = Join-Path $releaseDir $it.Name
                  Copy-Item -Path $it.FullName -Destination $dest -Force -ErrorAction SilentlyContinue
                  Write-Host "Copied: $($it.FullName) -> $dest"
                }
              } else {
                Write-Host "No files matched $p"
              }
            } Catch {
              Write-Host "Pattern $p skipped (no files)"
            }
          }

          # search whole repo as last resort for common artifact extensions and copy them
          Write-Host "Fallback search (common extensions: exe, msi, msix, zip, appx)..."
          $exts = @('*.exe','*.msi','*.msix','*.zip','*.appx','*.msixbundle','*.nupkg')
          foreach ($ext in $exts) {
            $found = Get-ChildItem -Path . -Include $ext -Recurse -File -ErrorAction SilentlyContinue | Where-Object { $_.FullName -notmatch '\\.git\\' }
            foreach ($f in $found) {
              $dest = Join-Path $releaseDir $f.Name
              Copy-Item -Path $f.FullName -Destination $dest -Force -ErrorAction SilentlyContinue
              Write-Host "Copied fallback: $($f.FullName) -> $dest"
            }
          }

          # If nothing found and test switch enabled, create test files
          $releaseFiles = Get-ChildItem -Path $releaseDir -Recurse -File -ErrorAction SilentlyContinue
          $installerCandidate = Get-ChildItem -Path $setupDir -Recurse -File -ErrorAction SilentlyContinue | Select-Object -First 1

          if ((-not $releaseFiles -or $releaseFiles.Count -eq 0) -and (-not $installerCandidate) -and $env:CREATE_TEST_ARTIFACTS -eq 'true') {
            Write-Host "No real artifacts found - creating small test artifacts..."
            "test artifact" | Out-File -FilePath (Join-Path $releaseDir "test-file.txt") -Encoding utf8
            $installerPath = Join-Path $setupDir ("PiliPlus_windows_${env:RELEASE_TAG}_test_setup.exe")
            "dummy installer content" | Out-File -FilePath $installerPath -Encoding ascii
            Write-Host "Test artifacts created: $installerPath"
          }

          # Create a zip of everything inside Release\PiliPlus-Win (if any)
          $finalZip = ""
          $releaseTag = $env:RELEASE_TAG
          if (-not $releaseTag) { $releaseTag = "auto-${{ github.run_id }}" }
          if ((Get-ChildItem -Path $releaseDir -Recurse -File -ErrorAction SilentlyContinue).Count -gt 0) {
            $finalZip = Join-Path $cwd ("PiliPlus_windows_${releaseTag}_arm64.zip")
            Compress-Archive -Path "$releaseDir\*" -DestinationPath $finalZip -Force
            Write-Host "Created zip: $finalZip"
          } else {
            Write-Host "No files in $releaseDir to zip."
          }

          # find any installer-like file under setup dir or repo
          $installer = Get-ChildItem -Path $setupDir -Recurse -File -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $installer) {
            $installer = Get-ChildItem -Path dist -Include *.exe,*.msi,*.msix -Recurse -File -ErrorAction SilentlyContinue | Select-Object -First 1
          }
          if ($installer) {
            $installerPath = $installer.FullName
            Write-Host "Installer candidate: $installerPath"
          } else {
            $installerPath = ""
            Write-Host "No installer candidate found."
          }

          Write-Host "`n-- Release folder listing --"
          Get-ChildItem -Path $releaseDir -Recurse -Force | Select-Object FullName,Length | Format-Table -AutoSize
          Write-Host "`n-- Setup folder listing --"
          Get-ChildItem -Path $setupDir -Recurse -Force | Select-Object FullName,Length | Format-Table -AutoSize

          $hasZip = ($finalZip -ne "" -and (Test-Path $finalZip))
          $hasInstaller = ($installerPath -ne "" -and (Test-Path $installerPath))
          $hasArtifacts = $hasZip -or $hasInstaller -or ((Get-ChildItem -Path $releaseDir -Recurse -File -ErrorAction SilentlyContinue).Count -gt 0)

          Add-Content -Path $env:GITHUB_OUTPUT -Value "has_artifacts=$($hasArtifacts.ToString().ToLower())"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "has_zip=$($hasZip.ToString().ToLower())"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "has_installer=$($hasInstaller.ToString().ToLower())"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "release_zip=$finalZip"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "release_installer=$installerPath"

          Write-Host "outputs -> has_artifacts=$hasArtifacts, has_zip=$hasZip, has_installer=$hasInstaller"
          Write-Host "release_zip=$finalZip"
          Write-Host "release_installer=$installerPath"

      - name: Upload zip artifact (actions artifact, visible on Run page)
        if: ${{ steps.prepare.outputs.has_zip == 'true' }}
        uses: actions/upload-artifact@v5
        with:
          name: windows-arm64-release
          path: ${{ steps.prepare.outputs.release_zip }}

      - name: Upload installer artifact (actions artifact)
        if: ${{ steps.prepare.outputs.has_installer == 'true' }}
        uses: actions/upload-artifact@v5
        with:
          name: windows-setup-arm64-release
          path: ${{ steps.prepare.outputs.release_installer }}

      - name: Upload Release folder (fallback artifact)
        if: ${{ steps.prepare.outputs.has_artifacts == 'true' && steps.prepare.outputs.has_zip != 'true' && steps.prepare.outputs.has_installer != 'true' }}
        uses: actions/upload-artifact@v5
        with:
          name: Release-folder
          path: Release
